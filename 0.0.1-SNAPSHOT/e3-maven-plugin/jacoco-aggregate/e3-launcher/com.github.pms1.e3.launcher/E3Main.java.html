<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>E3Main.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Eclipse Equinox Embedder Maven Plugin</a> &gt; <a href="../index.html" class="el_bundle">e3-launcher</a> &gt; <a href="index.source.html" class="el_package">com.github.pms1.e3.launcher</a> &gt; <span class="el_source">E3Main.java</span></div><h1>E3Main.java</h1><pre class="source lang-java linenums">package com.github.pms1.e3.launcher;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.io.Writer;
import java.net.URL;
import java.net.URLConnection;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.Arrays;
import java.util.Comparator;
import java.util.HashMap;
import java.util.Hashtable;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Properties;
import java.util.ServiceLoader;
import java.util.logging.Level;
import java.util.logging.Logger;

import org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher;
import org.eclipse.osgi.framework.log.FrameworkLog;
import org.eclipse.osgi.framework.log.FrameworkLogEntry;
import org.eclipse.osgi.internal.framework.EquinoxConfiguration;
import org.eclipse.osgi.service.runnable.ApplicationLauncher;
import org.osgi.framework.Bundle;
import org.osgi.framework.BundleContext;
import org.osgi.framework.Constants;
import org.osgi.framework.FrameworkEvent;
import org.osgi.framework.ServiceRegistration;
import org.osgi.framework.launch.Framework;
import org.osgi.framework.launch.FrameworkFactory;
import org.osgi.service.url.AbstractURLStreamHandlerService;
import org.osgi.service.url.URLConstants;
import org.osgi.service.url.URLStreamHandlerService;

<span class="nc" id="L39">public class E3Main {</span>

<span class="nc" id="L41">	static class BundleConfiguration {</span>
		String file;
		int startLevel;
		boolean autostart;
		public Bundle bundle;
	}

<span class="nc" id="L48">	static Logger logger = Logger.getLogger(E3Main.class.getName());</span>

	public static void main(String[] args1) throws Exception {
<span class="nc" id="L51">		Properties launcherProperties = new Properties();</span>
<span class="nc" id="L52">		try (InputStream in = E3Main.class.getResourceAsStream(&quot;/launcher.properties&quot;)) {</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">			if (in == null)</span>
<span class="nc" id="L54">				throw new RuntimeException(&quot;Resource with configuration not found: /launcher.properties&quot;);</span>
<span class="nc" id="L55">			launcherProperties.load(in);</span>
<span class="nc bnc" id="L56" title="All 8 branches missed.">		}</span>

<span class="nc bnc" id="L58" title="All 2 branches missed.">		for (Map.Entry&lt;Object, Object&gt; e : launcherProperties.entrySet()) {</span>
<span class="nc" id="L59">			String key = (String) e.getKey();</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">			if (key.startsWith(&quot;system.&quot;))</span>
<span class="nc" id="L61">				System.setProperty(key.substring(7), (String) e.getValue());</span>
<span class="nc" id="L62">		}</span>

<span class="nc" id="L64">		FrameworkFactory frameworkFactory = ServiceLoader.load(FrameworkFactory.class).iterator().next();</span>

<span class="nc" id="L66">		Map&lt;String, String&gt; config = new HashMap&lt;String, String&gt;();</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">		for (Map.Entry&lt;Object, Object&gt; e : launcherProperties.entrySet()) {</span>
<span class="nc" id="L68">			String key = (String) e.getKey();</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">			if (key.startsWith(&quot;framework.&quot;))</span>
<span class="nc" id="L70">				config.put(key.substring(10), (String) e.getValue());</span>
<span class="nc" id="L71">		}</span>
<span class="nc" id="L72">		config.put(Constants.FRAMEWORK_STORAGE_CLEAN, &quot;true&quot;);</span>
		// set by EclipseStarter and needed to make some jvm packages visible
		// at runtime
		// config.put(&quot;osgi.compatibility.bootdelegation.default&quot;, &quot;true&quot;);
		// not sure how to handle this
		// config.put(&quot;eclipse.consoleLog&quot;, &quot;true&quot;);

<span class="nc" id="L79">		Path storage = Files.createTempDirectory(&quot;e3&quot;);</span>
<span class="nc" id="L80">		logger.fine(&quot;Using temporary storage &quot; + storage);</span>
<span class="nc" id="L81">		Runtime.getRuntime().addShutdownHook(new Thread() {</span>
			@Override
			public void run() {
				try {
<span class="nc" id="L85">					logger.fine(&quot;Deleting temporary storage &quot; + storage);</span>
<span class="nc" id="L86">					Files.walk(storage).sorted(Comparator.reverseOrder()).map(Path::toFile).forEach(File::delete);</span>
<span class="nc" id="L87">					logger.fine(&quot;Deleted temporary storage &quot; + storage);</span>
<span class="nc" id="L88">				} catch (IOException e) {</span>
<span class="nc" id="L89">					logger.log(Level.WARNING, &quot;Failed to delete temporary storage &quot; + storage + &quot;: &quot; + e, e);</span>
<span class="nc" id="L90">				}</span>
<span class="nc" id="L91">			}</span>
		});
<span class="nc" id="L93">		config.put(Constants.FRAMEWORK_STORAGE, storage.toString());</span>

		// copy pass-through configuration files to the configuration area
<span class="nc bnc" id="L96" title="All 2 branches missed.">		for (String s : launcherProperties.getProperty(&quot;configuration.copy&quot;).split(&quot;,&quot;, -1)) {</span>
<span class="nc" id="L97">			Path dest = storage.resolve(s);</span>
<span class="nc" id="L98">			Files.createDirectories(dest.getParent());</span>
<span class="nc" id="L99">			try (InputStream resourceAsStream = ClassLoader.getSystemClassLoader()</span>
<span class="nc" id="L100">					.getResourceAsStream(&quot;.configuration/&quot; + s)) {</span>
<span class="nc" id="L101">				Files.copy(resourceAsStream, dest);</span>
<span class="nc bnc" id="L102" title="All 8 branches missed.">			}</span>
		}
		// for (Object k : configIni.keySet())
		// config.put((String) k, configIni.getProperty((String) k));
		// config.remove(&quot;osgi.framework&quot;);

		// TODO: add some config properties

<span class="nc" id="L110">		logger.fine(&quot;creating framework with config = &quot; + config);</span>
<span class="nc" id="L111">		Framework framework = frameworkFactory.newFramework(config);</span>

<span class="nc" id="L113">		logger.fine(&quot;starting framework&quot;);</span>
<span class="nc" id="L114">		framework.start();</span>

		// install protocol handler for &quot;embedded&quot; protocol that is used to load
		// from the fat jar
		{
<span class="nc" id="L119">			Hashtable&lt;String, String[]&gt; properties = new Hashtable&lt;&gt;(1);</span>
<span class="nc" id="L120">			properties.put(URLConstants.URL_HANDLER_PROTOCOL, new String[] { &quot;embedded&quot; });</span>

<span class="nc" id="L122">			framework.getBundleContext().registerService(URLStreamHandlerService.class.getName(),</span>
<span class="nc" id="L123">					new AbstractURLStreamHandlerService() {</span>

						@Override
						public URLConnection openConnection(URL u) throws IOException {
<span class="nc" id="L127">							URL u2 = E3Main.class.getClassLoader().getResource(u.getPath());</span>

<span class="nc bnc" id="L129" title="All 2 branches missed.">							if (u2 == null)</span>
<span class="nc" id="L130">								throw new IOException(&quot;Not found: &quot; + u);</span>

<span class="nc" id="L132">							return u2.openConnection();</span>
						}

					}, properties);
		}

<span class="nc" id="L138">		List&lt;BundleConfiguration&gt; bs = new LinkedList&lt;&gt;();</span>

<span class="nc bnc" id="L140" title="All 2 branches missed.">		for (String bundle : launcherProperties.getProperty(&quot;osgi.bundles&quot;).split(&quot;,&quot;, -1)) {</span>

<span class="nc" id="L142">			BundleConfiguration b = new BundleConfiguration();</span>
<span class="nc" id="L143">			int x = bundle.indexOf(&quot;@&quot;);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">			if (x == -1)</span>
<span class="nc" id="L145">				throw new Error();</span>

			// FIXME: use RE

<span class="nc" id="L149">			b.file = bundle.substring(0, x);</span>

<span class="nc" id="L151">			String rest = bundle.substring(x + 1);</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">			if (rest.endsWith(&quot;:start&quot;)) {</span>
<span class="nc" id="L153">				b.autostart = true;</span>
<span class="nc" id="L154">				rest = rest.substring(0, rest.length() - 6);</span>
			}
<span class="nc" id="L156">			b.startLevel = Integer.valueOf(rest);</span>

<span class="nc" id="L158">			bs.add(b);</span>
		}

<span class="nc" id="L161">		BundleContext context = framework.getBundleContext();</span>

<span class="nc" id="L163">		logger.fine(&quot;installing bundles&quot;);</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">		for (BundleConfiguration b : bs) {</span>
<span class="nc" id="L165">			logger.finer(&quot;installing bundle &quot; + b.file);</span>
<span class="nc" id="L166">			b.bundle = context.installBundle(&quot;embedded:&quot; + b.file);</span>
<span class="nc" id="L167">		}</span>

<span class="nc" id="L169">		logger.fine(&quot;starting bundles&quot;);</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">		for (int sl = 0; sl &lt;= Integer.valueOf(config.get(&quot;osgi.bundles.defaultStartLevel&quot;)); ++sl) {</span>
<span class="nc" id="L171">			logger.fine(&quot;starting bundles in runlevel &quot; + sl);</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">			for (BundleConfiguration b : bs) {</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">				if (b.startLevel != sl)</span>
<span class="nc" id="L174">					continue;</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">				if (!b.autostart)</span>
<span class="nc" id="L176">					continue;</span>
<span class="nc" id="L177">				logger.fine(&quot;starting bundle &quot; + b.bundle.getSymbolicName());</span>
<span class="nc" id="L178">				b.bundle.start();</span>
<span class="nc" id="L179">			}</span>
		}

<span class="nc bnc" id="L182" title="All 2 branches missed.">		if (logger.isLoggable(Level.FINEST))</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">			for (Bundle b : context.getBundles())</span>
<span class="nc" id="L184">				logger.finest(&quot;bundle state: &quot; + b.getSymbolicName() + &quot; &quot; + b.getState());</span>

		int exitCode;
		try {

<span class="nc" id="L189">			boolean launchDefault = true;</span>
<span class="nc" id="L190">			EquinoxConfiguration equinoxConfig = null;</span>
<span class="nc" id="L191">			FrameworkLog log = new FrameworkLog() {</span>

				@Override
				public void log(FrameworkEvent frameworkEvent) {
<span class="nc" id="L195">					System.err.println(&quot;LOG &quot; + frameworkEvent);</span>
<span class="nc" id="L196">				}</span>

				@Override
				public void log(FrameworkLogEntry logEntry) {
<span class="nc" id="L200">					System.err.println(&quot;LOG &quot; + logEntry);</span>

<span class="nc" id="L202">				}</span>

				@Override
				public void setWriter(Writer newWriter, boolean append) {
<span class="nc" id="L206">					new Throwable().printStackTrace();</span>
					// TODO Auto-generated method stub

<span class="nc" id="L209">				}</span>

				@Override
				public void setFile(File newFile, boolean append) throws IOException {
					// TODO Auto-generated method stub
<span class="nc" id="L214">					new Throwable().printStackTrace();</span>

<span class="nc" id="L216">				}</span>

				@Override
				public File getFile() {
<span class="nc" id="L220">					new Throwable().printStackTrace();</span>
					// TODO Auto-generated method stub
<span class="nc" id="L222">					return null;</span>
				}

				@Override
				public void setConsoleLog(boolean consoleLog) {
<span class="nc" id="L227">					new Throwable().printStackTrace();</span>
					// TODO Auto-generated method stub

<span class="nc" id="L230">				}</span>

				@Override
				public void close() {
<span class="nc" id="L234">					new Throwable().printStackTrace();</span>
					// TODO Auto-generated method stub

<span class="nc" id="L237">				}</span>

			};

<span class="nc" id="L241">			EclipseAppLauncher appLauncher = new EclipseAppLauncher(context, false, launchDefault, log, equinoxConfig);</span>
<span class="nc" id="L242">			ServiceRegistration&lt;?&gt; appLauncherRegistration = context</span>
<span class="nc" id="L243">					.registerService(ApplicationLauncher.class.getName(), appLauncher, null);</span>

<span class="nc" id="L245">			logger.fine(&quot;Starting EclipseAppLauncher with arguments &quot; + Arrays.toString(args1));</span>
<span class="nc" id="L246">			Object result = appLauncher.start(args1);</span>
<span class="nc" id="L247">			logger.fine(&quot;EclipseAppLauncher exited normally&quot;);</span>

<span class="nc" id="L249">			appLauncherRegistration.unregister();</span>

<span class="nc bnc" id="L251" title="All 2 branches missed.">			if (result instanceof Integer)</span>
<span class="nc" id="L252">				exitCode = (Integer) result;</span>
			else
<span class="nc" id="L254">				exitCode = 0;</span>
<span class="nc" id="L255">		} catch (Throwable t) {</span>
<span class="nc" id="L256">			logger.log(Level.FINE, &quot;EclipseAppLauncher terminated with exception: &quot; + t, t);</span>
<span class="nc" id="L257">			t.printStackTrace();</span>
<span class="nc" id="L258">			exitCode = 1;</span>
		} finally {
<span class="nc" id="L260">			logger.fine(&quot;Initiating framework stop&quot;);</span>
<span class="nc" id="L261">			framework.stop();</span>
<span class="nc" id="L262">			logger.fine(&quot;Waiting for framework stop&quot;);</span>
<span class="nc" id="L263">			framework.waitForStop(0);</span>
<span class="nc" id="L264">		}</span>
<span class="nc" id="L265">		logger.fine(&quot;Exiting&quot;);</span>
<span class="nc" id="L266">		System.exit(exitCode);</span>
<span class="nc" id="L267">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>E3Main.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Eclipse Equinox Embedder Maven Plugin</a> &gt; <a href="../index.html" class="el_bundle">e3-launcher</a> &gt; <a href="index.source.html" class="el_package">com.github.pms1.e3.launcher</a> &gt; <span class="el_source">E3Main.java</span></div><h1>E3Main.java</h1><pre class="source lang-java linenums">package com.github.pms1.e3.launcher;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.io.Writer;
import java.net.URL;
import java.net.URLConnection;
import java.net.URLStreamHandler;
import java.net.URLStreamHandlerFactory;
import java.util.Arrays;
import java.util.HashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Properties;
import java.util.ServiceLoader;

import org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher;
import org.eclipse.osgi.framework.log.FrameworkLog;
import org.eclipse.osgi.framework.log.FrameworkLogEntry;
import org.eclipse.osgi.internal.framework.EquinoxConfiguration;
import org.eclipse.osgi.service.runnable.ApplicationLauncher;
import org.osgi.framework.Bundle;
import org.osgi.framework.BundleContext;
import org.osgi.framework.Constants;
import org.osgi.framework.FrameworkEvent;
import org.osgi.framework.ServiceRegistration;
import org.osgi.framework.launch.Framework;
import org.osgi.framework.launch.FrameworkFactory;

<span class="nc" id="L32">public class E3Main {</span>

<span class="nc" id="L34">	static class B {</span>
		String file;
		int startLevel;
		boolean autostart;
		public Bundle bundle;
	}

	public static void main(String[] args1) throws Exception {
		int exitCode;

<span class="nc" id="L44">		System.out.println(&quot;RUNNING &quot; + Arrays.toString(args1));</span>

<span class="nc" id="L46">		Properties launcherProperties = new Properties();</span>
<span class="nc" id="L47">		try (InputStream in = E3Main.class.getResourceAsStream(&quot;/launcher.properties&quot;)) {</span>
<span class="nc" id="L48">			launcherProperties.load(in);</span>
<span class="nc bnc" id="L49" title="All 8 branches missed.">		}</span>

<span class="nc" id="L51">		System.out.println(&quot;PROP &quot; + launcherProperties);</span>

<span class="nc" id="L53">		ClassLoader cl = ClassLoader.getSystemClassLoader();</span>

		if (true) {
<span class="nc" id="L56">			URLStreamHandler fooHandler = new URLStreamHandler() {</span>

				@Override
				protected URLConnection openConnection(URL u) throws IOException {
<span class="nc" id="L60">					URLConnection x = cl.getResource(&quot;plugins/&quot; + u.getPath()).openConnection();</span>
<span class="nc" id="L61">					System.err.println(&quot;IS &quot; + x.getInputStream());</span>
<span class="nc" id="L62">					return cl.getResource(&quot;plugins/&quot; + u.getPath()).openConnection();</span>

					// Path p = root.resolve(&quot;plugins&quot;).resolve(u.getPath());
					//
					// System.err.println(&quot;P=&quot; + p);
					//
					// return p.toFile().toURI().toURL().openConnection();
				}
			};
<span class="nc" id="L71">			URL.setURLStreamHandlerFactory(new URLStreamHandlerFactory() {</span>

				@Override
				public URLStreamHandler createURLStreamHandler(String protocol) {
<span class="nc bnc" id="L75" title="All 2 branches missed.">					if (protocol.equals(&quot;foo&quot;))</span>
<span class="nc" id="L76">						return fooHandler;</span>
					else
<span class="nc" id="L78">						return null;</span>
				}
			});
		}

<span class="nc" id="L83">		FrameworkFactory frameworkFactory = ServiceLoader.load(FrameworkFactory.class).iterator().next();</span>
<span class="nc" id="L84">		Map&lt;String, String&gt; config = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L85">		config.put(Constants.FRAMEWORK_STORAGE_CLEAN, &quot;true&quot;);</span>
		// set by EclipseStarter and needed to make some jvm packages visiable
		// at runtime
<span class="nc" id="L88">		config.put(&quot;osgi.compatibility.bootdelegation.default&quot;, &quot;true&quot;);</span>
<span class="nc" id="L89">		config.put(&quot;eclipse.application&quot;, launcherProperties.getProperty(&quot;eclipse.application&quot;));</span>
<span class="nc" id="L90">		config.put(&quot;eclipse.consoleLog&quot;, &quot;true&quot;);</span>

		// FIXME
<span class="nc" id="L93">		config.put(Constants.FRAMEWORK_STORAGE, &quot;c:/temp/temp&quot;);</span>
		// for (Object k : configIni.keySet())
		// config.put((String) k, configIni.getProperty((String) k));
		// config.remove(&quot;osgi.framework&quot;);

		// TODO: add some config properties
<span class="nc" id="L99">		Framework framework = frameworkFactory.newFramework(config);</span>
<span class="nc" id="L100">		framework.start();</span>

<span class="nc" id="L102">		String property = framework.getBundleContext().getProperty(Constants.FRAMEWORK_SYSTEMPACKAGES);</span>

<span class="nc" id="L104">		System.err.println(&quot;X &quot; + property);</span>

<span class="nc" id="L106">		int maxStartLevel = -1;</span>

<span class="nc" id="L108">		List&lt;B&gt; bs = new LinkedList&lt;&gt;();</span>

<span class="nc bnc" id="L110" title="All 2 branches missed.">		for (String bundle : launcherProperties.getProperty(&quot;osgi.bundles&quot;).split(&quot;,&quot;, -1)) {</span>

<span class="nc" id="L112">			B b = new B();</span>
<span class="nc" id="L113">			int x = bundle.indexOf(&quot;@&quot;);</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">			if (x == -1)</span>
<span class="nc" id="L115">				throw new Error();</span>

<span class="nc" id="L117">			String ref = bundle.substring(0, x);</span>
<span class="nc" id="L118">			String p = &quot;reference:file:&quot;;</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">			if (!ref.startsWith(p))</span>
<span class="nc" id="L120">				throw new Error();</span>

<span class="nc" id="L122">			b.file = ref.substring(p.length());</span>

<span class="nc" id="L124">			String rest = bundle.substring(x + 1);</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">			if (rest.endsWith(&quot;:start&quot;)) {</span>
<span class="nc" id="L126">				b.autostart = true;</span>
<span class="nc" id="L127">				rest = rest.substring(0, rest.length() - 6);</span>
			}
<span class="nc" id="L129">			b.startLevel = Integer.valueOf(rest);</span>
<span class="nc" id="L130">			maxStartLevel = Math.max(b.startLevel, maxStartLevel);</span>

<span class="nc bnc" id="L132" title="All 2 branches missed.">			if (!b.file.endsWith(&quot;.jar&quot;)) {</span>
<span class="nc" id="L133">				System.err.println(&quot;SKIP &quot; + b.file);</span>
<span class="nc" id="L134">				continue;</span>
			}
<span class="nc" id="L136">			bs.add(b);</span>

		}

<span class="nc" id="L140">		System.err.println(&quot;S1&quot;);</span>
<span class="nc" id="L141">		BundleContext context = framework.getBundleContext();</span>
<span class="nc" id="L142">		System.err.println(&quot;S1.1&quot;);</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">		for (String bundle : launcherProperties.getProperty(&quot;osgi.framework.extensions&quot;).split(&quot;,&quot;, -1)) {</span>

<span class="nc" id="L145">			String p = &quot;reference:file:&quot;;</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">			if (!bundle.startsWith(p))</span>
<span class="nc" id="L147">				throw new Error();</span>

<span class="nc" id="L149">			System.err.println(&quot;INSTALL &quot; + bundle);</span>

<span class="nc" id="L151">			context.installBundle(&quot;foo:&quot; + bundle.substring(p.length()));</span>
		}

<span class="nc bnc" id="L154" title="All 2 branches missed.">		for (B b : bs) {</span>
<span class="nc" id="L155">			System.err.println(&quot;INSTALL &quot; + b.file);</span>
<span class="nc" id="L156">			b.bundle = context.installBundle(&quot;foo:&quot; + b.file);</span>
<span class="nc" id="L157">		}</span>
<span class="nc" id="L158">		System.err.println(&quot;INSTALLED &quot; + bs.size());</span>

<span class="nc bnc" id="L160" title="All 2 branches missed.">		for (int sl = 0; sl != maxStartLevel + 1; ++sl) {</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">			for (B b : bs) {</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">				if (b.startLevel != sl)</span>
<span class="nc" id="L163">					continue;</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">				if (!b.autostart)</span>
<span class="nc" id="L165">					continue;</span>
<span class="nc" id="L166">				System.err.println(&quot;START &quot; + sl + &quot; &quot; + b.bundle.getSymbolicName());</span>
<span class="nc" id="L167">				b.bundle.start();</span>
<span class="nc" id="L168">			}</span>
		}

<span class="nc" id="L171">		System.err.println(&quot;S3&quot;);</span>

		if (false)
<span class="nc" id="L174">			bs.stream().filter(b -&gt; b.file.contains(&quot;org.eclipse.core.runtime&quot;)).findFirst().get().bundle.start();</span>

<span class="nc bnc" id="L176" title="All 2 branches missed.">		for (Bundle b : context.getBundles()) {</span>
<span class="nc" id="L177">			System.err.println(&quot;STATE &quot; + b.getSymbolicName() + &quot; &quot; + b.getState());</span>
		}
		try {

<span class="nc" id="L181">			boolean launchDefault = true;</span>
<span class="nc" id="L182">			EquinoxConfiguration equinoxConfig = null;</span>
<span class="nc" id="L183">			FrameworkLog log = new FrameworkLog() {</span>

				@Override
				public void log(FrameworkEvent frameworkEvent) {
<span class="nc" id="L187">					System.err.println(&quot;LOG &quot; + frameworkEvent);</span>
<span class="nc" id="L188">				}</span>

				@Override
				public void log(FrameworkLogEntry logEntry) {
<span class="nc" id="L192">					System.err.println(&quot;LOG &quot; + logEntry);</span>

<span class="nc" id="L194">				}</span>

				@Override
				public void setWriter(Writer newWriter, boolean append) {
<span class="nc" id="L198">					new Throwable().printStackTrace();</span>
					// TODO Auto-generated method stub

<span class="nc" id="L201">				}</span>

				@Override
				public void setFile(File newFile, boolean append) throws IOException {
					// TODO Auto-generated method stub
<span class="nc" id="L206">					new Throwable().printStackTrace();</span>

<span class="nc" id="L208">				}</span>

				@Override
				public File getFile() {
<span class="nc" id="L212">					new Throwable().printStackTrace();</span>
					// TODO Auto-generated method stub
<span class="nc" id="L214">					return null;</span>
				}

				@Override
				public void setConsoleLog(boolean consoleLog) {
<span class="nc" id="L219">					new Throwable().printStackTrace();</span>
					// TODO Auto-generated method stub

<span class="nc" id="L222">				}</span>

				@Override
				public void close() {
<span class="nc" id="L226">					new Throwable().printStackTrace();</span>
					// TODO Auto-generated method stub

<span class="nc" id="L229">				}</span>

			};
<span class="nc" id="L232">			EclipseAppLauncher appLauncher = new EclipseAppLauncher(context, false, launchDefault, log, equinoxConfig);</span>
<span class="nc" id="L233">			ServiceRegistration&lt;?&gt; appLauncherRegistration = context</span>
<span class="nc" id="L234">					.registerService(ApplicationLauncher.class.getName(), appLauncher, null);</span>

<span class="nc" id="L236">			System.err.println(&quot;S3&quot;);</span>

<span class="nc" id="L238">			appLauncher.start(args1);</span>

<span class="nc" id="L240">			exitCode = 0;</span>
<span class="nc" id="L241">		} catch (Throwable t) {</span>
<span class="nc" id="L242">			t.printStackTrace();</span>
<span class="nc" id="L243">			exitCode = 1;</span>
		} finally {
<span class="nc" id="L245">			framework.stop();</span>
<span class="nc" id="L246">			System.err.println(&quot;S4.1&quot;);</span>
<span class="nc" id="L247">			framework.waitForStop(0);</span>
<span class="nc" id="L248">			System.err.println(&quot;S7&quot;);</span>
<span class="nc" id="L249">		}</span>
<span class="nc" id="L250">		System.exit(exitCode);</span>
<span class="nc" id="L251">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>